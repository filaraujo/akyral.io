<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-a11y-keys/core-a11y-keys.html">

<!--
A responsive dialog/modal element.

##Responsive Breakpoints
`akyral-dialog` is currently built using the following breakpoints.

<pre>
    <code>
         0        480px         720px        944px        1264px    1920px
         ├─────────┼─────────────┼─────────────┼───────────┼─────────┼─────────>
         ·  phone  ·   phablet   ·   tablet    ·  desktop  ·   hd    ·
    </code>
</pre>

## Using the element
### Nested content
Using the element is as simple as defining a `akyral-dialog` element and nesting content

Example:

    <akyral-dialog>
        I am content...
    </akyral-dialog>


### Extending
You can extend `akyral-dialog` directly. Note the shadow element that will transfer akyral-dialog
shadow DOM into the new element

Example:

    <polymer-element name="new-dialog" extends="akyral-dialog">
        <template>
            <shadow></shadow>
        </template>
        <script>
            Polymer('new-dialog', {});
        </script>
    </polymer-element>


### Setting `.contents`
You can also define an empty `akryal-dialog` element and set the contents at any point

Example:

    <akyral-dialog id="dialog"></akyral-dialog>

    <div id="dialog-contents">
        I am content...
    </div>

    <script>
        var dialog = document.querySelector('#dialog'),
            content = document.querySelector('#dialog-content');

        dialog.contents = content;
    </script>


## Type
Setting a type allows you to define a visual effect to the dialog. You can
choose from the following types: `drop`, `flip`, `lift`, `slide`, `swing` and
`takeover`.

Example:

    <akyral-dialog type="flip"></akyral-dialog>

## Position
Setting a position will set the visual effect's starting position. You can
choose from the following position: `top`, `left`, `bottom`, and `right`.
A dialog with a type of `takeover` is not affected by position.

Example:

    <akyral-dialog type="slide" position="top"></akyral-dialog>


## Pinned location
Setting the `pinned` attribute will pin the element to that side on the viewport.
This will override the position attribute. Only types of `swing` and `slide` support the pinned attribute.

Example:

    <akyral-dialog type="slide" position="top" pinned="top"></akyral-dialog>

@element akyral-dialog
@blurb Web component which allows for easy modal creation
@status alpha
@homepage http://filaraujo.github.io/akyral-dialog
@demo http://filaraujo.github.io/akyral-dialog/components/akyral-dialog/demo
-->

<polymer-element name="akyral-dialog">
    <template>

        <link rel="stylesheet" href="akyral-dialog.css" />

        <core-a11y-keys
            target="{{}}"
            keys="esc"
            on-keys-pressed="{{ close }}">
        </core-a11y-keys>

        <core-a11y-keys
            target="{{}}"
            keys="tab"
            on-keys-pressed="{{ setFocus }}">
        </core-a11y-keys>

        <div id="modal" type="{{type}}" position="{{position}}" pinned="{{pinned}}">
            <content id="content"></content>
        </div>

    </template>
    <script>
        (function(){
            var authors = ['Filipe Araujo'],

                targetEl,

                targetElParent,

                lastFocus,

                focusableSelectors = 'a[href], button, input, textarea, select',

                baseEl = document.createElement('akyral-dialog');


            // inject core dialog to page
            baseEl.setAttribute('core','');
            baseEl.show = baseEl.toggle = baseEl.close = warnApi;
            document.body.insertBefore(baseEl, document.body.firstChild);

            /**
              * The `setFocus` will query the contents of the dialog for any element that is
              * focusable. It will determine the focused index and choose the next appropriate
              * element to focus. It will stay within the modal to prevent from leaving.
              *
              * @method setFocus
              * @private
              */
            function setFocus(e){
                var nodes = this.querySelectorAll(focusableSelectors),
                    nodesArray = [].slice.call(nodes, 0),
                    focusedIndex = nodesArray.indexOf(document.activeElement);

                if(focusedIndex === nodesArray.length - 1){
                    focusedIndex = -1;
                }

                nodesArray[focusedIndex + 1] && nodesArray[focusedIndex + 1].focus();
            }

            /**
              * Attempting to call methods against the instance managed `akyral-dialog` will result
              * in calling `warnApi` instead.
              *
              * @method warnApi
              * @private
              */
            function warnApi(){
                console.error('akyral-dialog :: You can\'t interact with this element directly');
            }

            Polymer('akyral-dialog', {

                /**
                 * The `author` attribute defines the initial author, setting
                 * this value will add another author
                 *
                 * @attribute author
                 * @type string
                 * @default 'Filipe Araujo'
                 */
                set author(name){
                    if(authors.indexOf(name) > 0){
                        return;
                    }
                    authors = [].concat.apply(authors, [name]);
                },

                get author(){
                    return authors;
                },

                publish: {

                    /**
                     * The `pinned` will pin the element to that side on the
                     * viewport.  Only supported by elements with type of
                     * `slide` and `swing`
                     *
                     * @attribute pinned
                     * @type string
                     * @default null
                     */
                    pinned: {
                        reflect: true,
                        value: undefined
                    },

                    /**
                     * The `position` attribute defines the visual effect's
                     * starting position
                     *
                     * @attribute position
                     * @type string
                     * @default null
                     */
                    position: {
                        reflect: true,
                        value: undefined
                    },

                    /**
                     * The `shown` attribute manages the visibility state of the
                     * dialog
                     *
                     * @attribute shown
                     * @type boolean
                     * @default false
                     */

                    shown: {
                        reflect: true,
                        value: false
                    },

                    /**
                     * The `type` attribute defines the visual effect of the
                     * dialog. It defaults to `takeover` if it is not defined
                     *
                     * @attribute type
                     * @type string
                     * @default 'takeover'
                     */
                    type: {
                        reflect: true,
                        value: 'takeover'
                    }
                },

                /**
                * The `close` method will close the dialog
                *
                * @method close
                */
                close: function(){
                    this.shown = false;
                    targetElParent.appendChild( targetEl );
                    targetEl.removeAttribute('content');

                    lastFocus.focus();
                    this.fire('dialog-closed', { dialog: this });
                },

                setFocus: setFocus,

                /**
                * The `show` method will open the dialog
                *
                * @method show
                */
                show: function(){
                    targetEl = this;
                    targetEl.setAttribute('content','');
                    targetElParent = this.parentNode || document.body;

                    baseEl.bind( 'pinned', new PathObserver( this, 'pinned' ) );
                    baseEl.bind( 'position', new PathObserver( this, 'position' ) );
                    baseEl.bind( 'shown', new PathObserver( this, 'shown' ) );
                    baseEl.bind( 'type', new PathObserver( this, 'type' ) );

                    baseEl.appendChild( targetEl );
                    this.shown = true;

                    lastFocus = document.activeElement;
                    this.setFocus();
                    this.fire('dialog-shown', { dialog: this });
                },

                /**
                * The `contentsChanged` method will inject the content into the modal
                *
                * @method contentsChanged
                */
                contentsChanged: function(){
                    this.appendChild(this.contents);
                    this.contents.eventController = this.element.findController(this.contents);
                },

                /**
                * The `toggle` method will open and close the dialog
                *
                * @method toggle
                */
                toggle: function(){
                    this[ this.shown ? 'close' : 'show' ]();
                }
            });
        }());
    </script>
</polymer-element>
